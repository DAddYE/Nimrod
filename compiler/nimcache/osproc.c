/* Generated by Nimrod Compiler v0.9.3 */
/*   (c) 2012 Andreas Rumpf */
/* The generated code is subject to the original license. */
/* Compiled for: MacOSX, amd64, gcc */
/* Command for C compiler:
   gcc -c  -w -O3 -fno-strict-aliasing  -I/usr/src/extras/Nimrod/lib -o compiler/nimcache/osproc.o compiler/nimcache/osproc.c */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <sys/types.h>

#include <unistd.h>

#include <spawn.h>

#include <signal.h>

#include <string.h>

#include <sys/wait.h>

#include <stdio.h>
typedef struct tprocess152203 tprocess152203;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
typedef struct TY95234 TY95234;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct tcell38449 tcell38449;
typedef struct tcellseq38465 tcellseq38465;
typedef struct tgcheap40416 tgcheap40416;
typedef struct tcellset38461 tcellset38461;
typedef struct tpagedesc38457 tpagedesc38457;
typedef struct tmemregion22010 tmemregion22010;
typedef struct tsmallchunk21243 tsmallchunk21243;
typedef struct tllchunk22004 tllchunk22004;
typedef struct tbigchunk21245 tbigchunk21245;
typedef struct tintset21218 tintset21218;
typedef struct ttrunk21214 ttrunk21214;
typedef struct tavlnode22008 tavlnode22008;
typedef struct tgcstat40414 tgcstat40414;
typedef struct tstringtable103609 tstringtable103609;
typedef struct TNimObject TNimObject;
typedef struct tstream150630 tstream150630;
typedef struct tkeyvaluepairseq103607 tkeyvaluepairseq103607;
typedef struct tkeyvaluepair103605 tkeyvaluepair103605;
typedef struct tfilestream151125 tfilestream151125;
typedef struct TY153003 TY153003;
typedef struct tbasechunk21241 tbasechunk21241;
typedef struct tfreecell21233 tfreecell21233;
struct TGenericSeq {
NI len;
NI reserved;
};
typedef NIM_CHAR TY611[100000001];
struct NimStringDesc {
  TGenericSeq Sup;
TY611 data;
};
typedef N_NIMCALL_PTR(void, TY891) (void* p, NI op);
struct TNimType {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY891 marker;
};
struct TNimNode {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct tcell38449 {
NI Refcount;
TNimType* Typ;
};
struct tcellseq38465 {
NI Len;
NI Cap;
tcell38449** D;
};
struct tcellset38461 {
NI Counter;
NI Max;
tpagedesc38457* Head;
tpagedesc38457** Data;
};
typedef tsmallchunk21243* TY22022[512];
typedef ttrunk21214* ttrunkbuckets21216[256];
struct tintset21218 {
ttrunkbuckets21216 Data;
};
struct tmemregion22010 {
NI Minlargeobj;
NI Maxlargeobj;
TY22022 Freesmallchunks;
tllchunk22004* Llmem;
NI Currmem;
NI Maxmem;
NI Freemem;
NI Lastsize;
tbigchunk21245* Freechunkslist;
tintset21218 Chunkstarts;
tavlnode22008* Root;
tavlnode22008* Deleted;
tavlnode22008* Last;
tavlnode22008* Freeavlnodes;
};
struct tgcstat40414 {
NI Stackscans;
NI Cyclecollections;
NI Maxthreshold;
NI Maxstacksize;
NI Maxstackcells;
NI Cycletablesize;
NI64 Maxpause;
};
struct tgcheap40416 {
void* Stackbottom;
NI Cyclethreshold;
tcellseq38465 Zct;
tcellseq38465 Decstack;
tcellset38461 Cycleroots;
tcellseq38465 Tempstack;
NI Recgclock;
tmemregion22010 Region;
tgcstat40414 Stat;
};
typedef int TY153594[2];
struct TNimObject {
TNimType* m_type;
};
struct tprocess152203 {
  TNimObject Sup;
int Inputhandle;
int Outputhandle;
int Errorhandle;
tstream150630* Instream;
tstream150630* Outstream;
tstream150630* Errstream;
pid_t Id;
int Exitcode;
};
struct tkeyvaluepair103605 {
NimStringDesc* Field0;
NimStringDesc* Field1;
};
struct tstringtable103609 {
  TNimObject Sup;
NI Counter;
tkeyvaluepairseq103607* Data;
NU8 Mode;
};
typedef NimStringDesc* TY129263[1];
typedef NimStringDesc* TY105434[2];
typedef NI TY21221[8];
struct tpagedesc38457 {
tpagedesc38457* Next;
NI Key;
TY21221 Bits;
};
struct tbasechunk21241 {
NI Prevsize;
NI Size;
NIM_BOOL Used;
};
struct tsmallchunk21243 {
  tbasechunk21241 Sup;
tsmallchunk21243* Next;
tsmallchunk21243* Prev;
tfreecell21233* Freelist;
NI Free;
NI Acc;
NF64 Data;
};
struct tllchunk22004 {
NI Size;
NI Acc;
tllchunk22004* Next;
};
struct tbigchunk21245 {
  tbasechunk21241 Sup;
tbigchunk21245* Next;
tbigchunk21245* Prev;
NI Align;
NF64 Data;
};
struct ttrunk21214 {
ttrunk21214* Next;
NI Key;
TY21221 Bits;
};
typedef tavlnode22008* TY22014[2];
struct tavlnode22008 {
TY22014 Link;
NI Key;
NI Upperbound;
NI Level;
};
typedef N_NIMCALL_PTR(void, TY150631) (tstream150630* s);
typedef N_NIMCALL_PTR(NIM_BOOL, TY150635) (tstream150630* s);
typedef N_NIMCALL_PTR(void, TY150639) (tstream150630* s, NI pos);
typedef N_NIMCALL_PTR(NI, TY150644) (tstream150630* s);
typedef N_NIMCALL_PTR(NI, TY150648) (tstream150630* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY150654) (tstream150630* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY150660) (tstream150630* s);
struct tstream150630 {
  TNimObject Sup;
TY150631 Closeimpl;
TY150635 Atendimpl;
TY150639 Setpositionimpl;
TY150644 Getpositionimpl;
TY150648 Readdataimpl;
TY150654 Writedataimpl;
TY150660 Flushimpl;
};
struct tfilestream151125 {
  tstream150630 Sup;
FILE* F;
};
struct tfreecell21233 {
tfreecell21233* Next;
NI Zerofield;
};
struct TY95234 {
  TGenericSeq Sup;
  NimStringDesc* data[SEQ_DECL_SIZE];
};
struct tkeyvaluepairseq103607 {
  TGenericSeq Sup;
  tkeyvaluepair103605 data[SEQ_DECL_SIZE];
};
struct TY153003 {
  TGenericSeq Sup;
  tprocess152203* data[SEQ_DECL_SIZE];
};
N_NIMCALL(TY95234*, nosparseCmdLine)(NimStringDesc* c);
N_NIMCALL(void*, newSeq)(TNimType* typ, NI len);
N_NIMCALL(NimStringDesc*, copyStringRC1)(NimStringDesc* src);
static N_INLINE(void, nimGCunrefNoCycle)(void* p);
static N_INLINE(tcell38449*, usrtocell_41843)(void* usr);
static N_INLINE(void, rtladdzct_43002)(tcell38449* c);
N_NOINLINE(void, addzct_41815)(tcellseq38465* s, tcell38449* c);
N_NIMCALL(tprocess152203*, nospstartProcess)(NimStringDesc* command, NimStringDesc* workingdir, NimStringDesc** args, NI argslen0, tstringtable103609* env, NU8 options);
N_NIMCALL(void, nimGCvisit)(void* d, NI op);
N_NIMCALL(void, TMP2536)(void* p, NI op);
N_NIMCALL(void*, newObj)(TNimType* typ, NI size);
N_NIMCALL(void, oserror_92005)(NI32 errorcode);
N_NIMCALL(NI32, oslasterror_92052)(void);
N_NIMCALL(NCSTRING*, envtocstringarray_153515)(void);
N_NIMCALL(void, getenvvarsc_95402)(void);
N_NIMCALL(NI, nsuFindChar)(NimStringDesc* s, NIM_CHAR sub, NI start);
N_NIMCALL(NimStringDesc*, copyStrLast)(NimStringDesc* s, NI start_63424, NI last);
N_NIMCALL(NimStringDesc*, copyStrLast)(NimStringDesc* s, NI first, NI last);
N_NIMCALL(NimStringDesc*, copyStr)(NimStringDesc* s, NI start);
N_NIMCALL(NimStringDesc*, copyStr)(NimStringDesc* s, NI first);
N_NOCONV(void*, alloc0_4004)(NI size);
static N_INLINE(void, appendString)(NimStringDesc* dest, NimStringDesc* src);
N_NIMCALL(NimStringDesc*, rawNewString)(NI space);
N_NOCONV(void*, alloc_4001)(NI size);
N_NIMCALL(NCSTRING*, tocstringarray_153482)(tstringtable103609* t);
N_NIMCALL(NI, nstlen)(tstringtable103609* t);
static N_INLINE(void, setcurrentdir_93803)(NimStringDesc* newdir);
N_NIMCALL(NCSTRING*, tocstringarray_153424)(NimStringDesc** b, NI blen0, NimStringDesc** a, NI alen0);
N_NIMCALL(NimStringDesc*, nosextractFilename)(NimStringDesc* path);
N_NIMCALL(NimStringDesc*, addcmdargs_153404)(NimStringDesc* command, NimStringDesc** args, NI argslen0);
N_NIMCALL(NimStringDesc*, quoteifcontainswhite_78720)(NimStringDesc* s);
N_NIMCALL(NimStringDesc*, resizeString)(NimStringDesc* dest, NI addlen);
N_NIMCALL(NimStringDesc*, copyString)(NimStringDesc* src);
N_NIMCALL(void, dealloccstringarray_9437)(NCSTRING* a);
N_NIMCALL(NimStringDesc*, nsuJoinSep)(NimStringDesc** a, NI alen0, NimStringDesc* sep);
N_NIMCALL(void, createstream_154009)(tstream150630** stream, int* handle, NU8 filemode);
N_NIMCALL(NIM_BOOL, open_8826)(FILE** f, int filehandle, NU8 mode);
N_NIMCALL(tfilestream151125*, newfilestream_151183)(FILE* f);
N_NIMCALL(void, unsureAsgnRef)(void** dest, void* src);
N_NIMCALL(void, TMP3603)(void* p, NI op);
N_NIMCALL(tprocess152203*, startcmd_152246)(NimStringDesc* command, NU8 options);
static N_INLINE(void, asgnRefNoCycle)(void** dest, void* src);
N_NIMCALL(void, nossleep)(NI milsecs);
N_NIMCALL(NIM_BOOL, nosprunning)(tprocess152203* p);
N_NIMCALL(NI, nospwaitForExit)(tprocess152203* p, NI timeout);
N_NIMCALL(void, nospclose)(tprocess152203* p);
N_NIMCALL(void, close_150675)(tstream150630* s);
STRING_LITERAL(TMP2537, "=", 1);
STRING_LITERAL(TMP2538, " ", 1);
STRING_LITERAL(TMP2540, "sh", 2);
STRING_LITERAL(TMP2541, "-c", 2);
NIM_CONST TY105434 TMP2539 = {((NimStringDesc*) &TMP2540),
((NimStringDesc*) &TMP2541)}
;
STRING_LITERAL(TMP2542, "", 0);
extern TNimType NTI95234; /* seq[string] */
extern tgcheap40416 gch_40442;
extern TNimType NTI1009; /* TObject */
TNimType NTI152203; /* TProcess */
extern TNimType NTI8808; /* TFileHandle */
extern TNimType NTI150628; /* PStream */
extern TNimType NTI84455; /* TPid */
extern TNimType NTI3701; /* cint */
TNimType NTI152205; /* PProcess */
extern TY95234* environment_95235;
TNimType NTI153003; /* seq[PProcess] */

static N_INLINE(tcell38449*, usrtocell_41843)(void* usr) {
	tcell38449* result;
	result = 0;
	result = ((tcell38449*) ((NI)((NU64)(((NI) (usr))) - (NU64)(((NI)sizeof(tcell38449))))));
	return result;
}

static N_INLINE(void, rtladdzct_43002)(tcell38449* c) {
	addzct_41815(&gch_40442.Zct, c);
}

static N_INLINE(void, nimGCunrefNoCycle)(void* p) {
	tcell38449* c;
	c = usrtocell_41843(p);
	{
		(*c).Refcount -= 8;
		if (!((NU64)((*c).Refcount) < (NU64)(8))) goto LA3;
		rtladdzct_43002(c);
	}
	LA3: ;
}
N_NIMCALL(void, TMP2536)(void* p, NI op) {
	tprocess152203* a;
	a = (tprocess152203*)p;
	nimGCvisit((void*)(*a).Instream, op);
	nimGCvisit((void*)(*a).Outstream, op);
	nimGCvisit((void*)(*a).Errstream, op);
}

static N_INLINE(void, appendString)(NimStringDesc* dest, NimStringDesc* src) {
	memcpy(((NCSTRING) (&(*dest).data[((*dest).Sup.len)- 0])), ((NCSTRING) ((*src).data)), (NI64)((*src).Sup.len + 1));
	(*dest).Sup.len += (*src).Sup.len;
}

N_NIMCALL(NCSTRING*, envtocstringarray_153515)(void) {
	NCSTRING* result;
	NI counter;
	NimStringDesc* key_153519;
	NimStringDesc* val_153520;
	NI i_153552;
	NI HEX3Atmp_153554;
	NI res_153556;
	void* LOC2;
	NI i;
	NimStringDesc* key_153535;
	NimStringDesc* val_153536;
	NI i_153568;
	NI HEX3Atmp_153570;
	NI res_153572;
	result = 0;
	counter = 0;
	key_153519 = 0;
	val_153520 = 0;
	getenvvarsc_95402();
	i_153552 = 0;
	HEX3Atmp_153554 = 0;
	HEX3Atmp_153554 = (environment_95235->Sup.len-1);
	res_153556 = 0;
	while (1) {
		NI p_153558;
		if (!(res_153556 <= HEX3Atmp_153554)) goto LA1;
		i_153552 = res_153556;
		p_153558 = nsuFindChar(environment_95235->data[i_153552], 61, 0);
		key_153519 = copyStrLast(environment_95235->data[i_153552], 0, (NI64)(p_153558 - 1));
		val_153520 = copyStr(environment_95235->data[i_153552], (NI64)(p_153558 + 1));
		counter += 1;
		res_153556 += 1;
	} LA1: ;
	LOC2 = alloc0_4004((NI64)((NI64)(counter + 1) * 8));
	result = ((NCSTRING*) (LOC2));
	i = 0;
	key_153535 = 0;
	val_153536 = 0;
	getenvvarsc_95402();
	i_153568 = 0;
	HEX3Atmp_153570 = 0;
	HEX3Atmp_153570 = (environment_95235->Sup.len-1);
	res_153572 = 0;
	while (1) {
		NI p_153574;
		NimStringDesc* x;
		NimStringDesc* LOC4;
		void* LOC5;
		if (!(res_153572 <= HEX3Atmp_153570)) goto LA3;
		i_153568 = res_153572;
		p_153574 = nsuFindChar(environment_95235->data[i_153568], 61, 0);
		key_153535 = copyStrLast(environment_95235->data[i_153568], 0, (NI64)(p_153574 - 1));
		val_153536 = copyStr(environment_95235->data[i_153568], (NI64)(p_153574 + 1));
		LOC4 = 0;
		LOC4 = rawNewString(key_153535->Sup.len + val_153536->Sup.len + 1);
appendString(LOC4, key_153535);
appendString(LOC4, ((NimStringDesc*) &TMP2537));
appendString(LOC4, val_153536);
		x = LOC4;
		LOC5 = alloc_4001((NI64)(x->Sup.len + 1));
		result[(i)- 0] = ((NCSTRING) (LOC5));
		memcpy(((void*) (result[(i)- 0])), ((void*) (&x->data[0])), (NI64)(x->Sup.len + 1));
		i += 1;
		res_153572 += 1;
	} LA3: ;
	return result;
}

N_NIMCALL(NCSTRING*, tocstringarray_153482)(tstringtable103609* t) {
	NCSTRING* result;
	NI LOC1;
	void* LOC2;
	NI i;
	NimStringDesc* key_153488;
	NimStringDesc* val_153489;
	NI h_153508;
	NI HEX3Atmp_153510;
	NI res_153512;
	result = 0;
	LOC1 = nstlen(t);
	LOC2 = alloc0_4004((NI64)((NI64)(LOC1 + 1) * 8));
	result = ((NCSTRING*) (LOC2));
	i = 0;
	key_153488 = 0;
	val_153489 = 0;
	h_153508 = 0;
	HEX3Atmp_153510 = 0;
	HEX3Atmp_153510 = ((*t).Data->Sup.len-1);
	res_153512 = 0;
	while (1) {
		if (!(res_153512 <= HEX3Atmp_153510)) goto LA3;
		h_153508 = res_153512;
		{
			NimStringDesc* x;
			NimStringDesc* LOC8;
			void* LOC9;
			if (!!((*t).Data->data[h_153508].Field0 == 0)) goto LA6;
			key_153488 = (*t).Data->data[h_153508].Field0;
			val_153489 = (*t).Data->data[h_153508].Field1;
			LOC8 = 0;
			LOC8 = rawNewString(key_153488->Sup.len + val_153489->Sup.len + 1);
appendString(LOC8, key_153488);
appendString(LOC8, ((NimStringDesc*) &TMP2537));
appendString(LOC8, val_153489);
			x = LOC8;
			LOC9 = alloc_4001((NI64)(x->Sup.len + 1));
			result[(i)- 0] = ((NCSTRING) (LOC9));
			memcpy(((void*) (result[(i)- 0])), ((void*) (&x->data[0])), (NI64)(x->Sup.len + 1));
			i += 1;
		}
		LA6: ;
		res_153512 += 1;
	} LA3: ;
	return result;
}

static N_INLINE(void, setcurrentdir_93803)(NimStringDesc* newdir) {
	{
		int LOC3;
		NI32 LOC6;
		LOC3 = chdir(newdir->data);
		if (!!((LOC3 == ((NI32) 0)))) goto LA4;
		LOC6 = oslasterror_92052();
		oserror_92005(LOC6);
	}
	LA4: ;
}

N_NIMCALL(NCSTRING*, tocstringarray_153424)(NimStringDesc** b, NI blen0, NimStringDesc** a, NI alen0) {
	NCSTRING* result;
	void* LOC1;
	NI i_153448;
	NI HEX3Atmp_153470;
	NI res_153472;
	NI i_153456;
	NI HEX3Atmp_153475;
	NI res_153477;
	result = 0;
	LOC1 = alloc0_4004((NI64)((NI64)((NI64)(alen0 + blen0) + 1) * 8));
	result = ((NCSTRING*) (LOC1));
	i_153448 = 0;
	HEX3Atmp_153470 = 0;
	HEX3Atmp_153470 = (blen0-1);
	res_153472 = 0;
	while (1) {
		void* LOC3;
		if (!(res_153472 <= HEX3Atmp_153470)) goto LA2;
		i_153448 = res_153472;
		LOC3 = alloc_4001((NI64)(b[i_153448]->Sup.len + 1));
		result[(i_153448)- 0] = ((NCSTRING) (LOC3));
		memcpy(((void*) (result[(i_153448)- 0])), ((void*) (b[i_153448]->data)), (NI64)(b[i_153448]->Sup.len + 1));
		res_153472 += 1;
	} LA2: ;
	i_153456 = 0;
	HEX3Atmp_153475 = 0;
	HEX3Atmp_153475 = (alen0-1);
	res_153477 = 0;
	while (1) {
		void* LOC5;
		if (!(res_153477 <= HEX3Atmp_153475)) goto LA4;
		i_153456 = res_153477;
		LOC5 = alloc_4001((NI64)(a[i_153456]->Sup.len + 1));
		result[((NI64)(i_153456 + blen0))- 0] = ((NCSTRING) (LOC5));
		memcpy(((void*) (result[((NI64)(i_153456 + blen0))- 0])), ((void*) (a[i_153456]->data)), (NI64)(a[i_153456]->Sup.len + 1));
		res_153477 += 1;
	} LA4: ;
	return result;
}

N_NIMCALL(NimStringDesc*, addcmdargs_153404)(NimStringDesc* command, NimStringDesc** args, NI argslen0) {
	NimStringDesc* result;
	NI i_153417;
	NI HEX3Atmp_153418;
	NI res_153420;
	result = 0;
	result = quoteifcontainswhite_78720(command);
	i_153417 = 0;
	HEX3Atmp_153418 = 0;
	HEX3Atmp_153418 = (argslen0-1);
	res_153420 = 0;
	while (1) {
		NimStringDesc* LOC2;
		if (!(res_153420 <= HEX3Atmp_153418)) goto LA1;
		i_153417 = res_153420;
		result = resizeString(result, 1);
appendString(result, ((NimStringDesc*) &TMP2538));
		LOC2 = 0;
		LOC2 = quoteifcontainswhite_78720(args[i_153417]);
		result = resizeString(result, LOC2->Sup.len + 0);
appendString(result, LOC2);
		res_153420 += 1;
	} LA1: ;
	return result;
}

N_NIMCALL(tprocess152203*, nospstartProcess)(NimStringDesc* command, NimStringDesc* workingdir, NimStringDesc** args, NI argslen0, tstringtable103609* env, NU8 options) {
	tprocess152203* result;
	TY153594 pstdin;
	TY153594 pstdout;
	TY153594 pstderr;
	pid_t pid;
	posix_spawnattr_t attr;
	posix_spawn_file_actions_t fops;
	sigset_t mask;
	NCSTRING* e;
	NCSTRING* a;
	int res;
	int LOC120;
	int LOC121;
	result = 0;
	memset((void*)pstdin, 0, sizeof(pstdin));
	memset((void*)pstdout, 0, sizeof(pstdout));
	memset((void*)pstderr, 0, sizeof(pstderr));
	result = (tprocess152203*) newObj((&NTI152205), sizeof(tprocess152203));
	(*result).Sup.m_type = (&NTI152203);
	(*result).Exitcode = ((int) -3);
	{
		if (!!(((options &(1<<((((NU8) 3))&7)))!=0))) goto LA3;
		{
			NIM_BOOL LOC7;
			NIM_BOOL LOC8;
			int LOC9;
			int LOC11;
			int LOC13;
			NI32 LOC16;
			LOC9 = pipe(pstdin);
			LOC8 = !((LOC9 == ((NI32) 0)));
			if (LOC8) goto LA10;
			LOC11 = pipe(pstdout);
			LOC8 = !((LOC11 == ((NI32) 0)));
			LA10: ;
			LOC7 = LOC8;
			if (LOC7) goto LA12;
			LOC13 = pipe(pstderr);
			LOC7 = !((LOC13 == ((NI32) 0)));
			LA12: ;
			if (!LOC7) goto LA14;
			LOC16 = oslasterror_92052();
			oserror_92005(LOC16);
		}
		LA14: ;
	}
	LA3: ;
	pid = 0;
	memset((void*)&attr, 0, sizeof(attr));
	memset((void*)&fops, 0, sizeof(fops));
	{
		int LOC19;
		NI32 LOC22;
		LOC19 = posix_spawn_file_actions_init(&fops);
		if (!!((LOC19 == ((NI32) 0)))) goto LA20;
		LOC22 = oslasterror_92052();
		oserror_92005(LOC22);
	}
	LA20: ;
	{
		int LOC25;
		NI32 LOC28;
		LOC25 = posix_spawnattr_init(&attr);
		if (!!((LOC25 == ((NI32) 0)))) goto LA26;
		LOC28 = oslasterror_92052();
		oserror_92005(LOC28);
	}
	LA26: ;
	memset((void*)&mask, 0, sizeof(mask));
	{
		int LOC31;
		NI32 LOC34;
		LOC31 = sigemptyset(&mask);
		if (!!((LOC31 == ((NI32) 0)))) goto LA32;
		LOC34 = oslasterror_92052();
		oserror_92005(LOC34);
	}
	LA32: ;
	{
		int LOC37;
		NI32 LOC40;
		LOC37 = posix_spawnattr_setsigmask(&attr, &mask);
		if (!!((LOC37 == ((NI32) 0)))) goto LA38;
		LOC40 = oslasterror_92052();
		oserror_92005(LOC40);
	}
	LA38: ;
	{
		int LOC43;
		NI32 LOC46;
		LOC43 = posix_spawnattr_setpgroup(&attr, 0);
		if (!!((LOC43 == ((NI32) 0)))) goto LA44;
		LOC46 = oslasterror_92052();
		oserror_92005(LOC46);
	}
	LA44: ;
	{
		int LOC49;
		NI32 LOC52;
		LOC49 = posix_spawnattr_setflags(&attr, (NI32)((NI32)(((int) 0) | POSIX_SPAWN_SETSIGMASK) | POSIX_SPAWN_SETPGROUP));
		if (!!((LOC49 == ((NI32) 0)))) goto LA50;
		LOC52 = oslasterror_92052();
		oserror_92005(LOC52);
	}
	LA50: ;
	{
		if (!!(((options &(1<<((((NU8) 3))&7)))!=0))) goto LA55;
		{
			int LOC59;
			NI32 LOC62;
			LOC59 = posix_spawn_file_actions_addclose(&fops, pstdin[(1)- 0]);
			if (!!((LOC59 == ((NI32) 0)))) goto LA60;
			LOC62 = oslasterror_92052();
			oserror_92005(LOC62);
		}
		LA60: ;
		{
			int LOC65;
			NI32 LOC68;
			LOC65 = posix_spawn_file_actions_adddup2(&fops, pstdin[(0)- 0], ((int) 0));
			if (!!((LOC65 == ((NI32) 0)))) goto LA66;
			LOC68 = oslasterror_92052();
			oserror_92005(LOC68);
		}
		LA66: ;
		{
			int LOC71;
			NI32 LOC74;
			LOC71 = posix_spawn_file_actions_addclose(&fops, pstdout[(0)- 0]);
			if (!!((LOC71 == ((NI32) 0)))) goto LA72;
			LOC74 = oslasterror_92052();
			oserror_92005(LOC74);
		}
		LA72: ;
		{
			int LOC77;
			NI32 LOC80;
			LOC77 = posix_spawn_file_actions_adddup2(&fops, pstdout[(1)- 0], ((int) 1));
			if (!!((LOC77 == ((NI32) 0)))) goto LA78;
			LOC80 = oslasterror_92052();
			oserror_92005(LOC80);
		}
		LA78: ;
		{
			int LOC83;
			NI32 LOC86;
			LOC83 = posix_spawn_file_actions_addclose(&fops, pstderr[(0)- 0]);
			if (!!((LOC83 == ((NI32) 0)))) goto LA84;
			LOC86 = oslasterror_92052();
			oserror_92005(LOC86);
		}
		LA84: ;
		{
			if (!((options &(1<<((((NU8) 2))&7)))!=0)) goto LA89;
			{
				int LOC93;
				NI32 LOC96;
				LOC93 = posix_spawn_file_actions_adddup2(&fops, pstdout[(1)- 0], ((int) 2));
				if (!!((LOC93 == ((NI32) 0)))) goto LA94;
				LOC96 = oslasterror_92052();
				oserror_92005(LOC96);
			}
			LA94: ;
		}
		goto LA87;
		LA89: ;
		{
			{
				int LOC100;
				NI32 LOC103;
				LOC100 = posix_spawn_file_actions_adddup2(&fops, pstderr[(1)- 0], ((int) 2));
				if (!!((LOC100 == ((NI32) 0)))) goto LA101;
				LOC103 = oslasterror_92052();
				oserror_92005(LOC103);
			}
			LA101: ;
		}
		LA87: ;
	}
	LA55: ;
	{
		if (!(env == NIM_NIL)) goto LA106;
		e = envtocstringarray_153515();
	}
	goto LA104;
	LA106: ;
	{
		e = tocstringarray_153482(env);
	}
	LA104: ;
	a = 0;
	res = 0;
	{
		if (!(0 < workingdir->Sup.len)) goto LA111;
		setcurrentdir_93803(workingdir);
	}
	LA111: ;
	{
		TY129263 LOC117;
		if (!!(((options &(1<<((((NU8) 1))&7)))!=0))) goto LA115;
		memset((void*)LOC117, 0, sizeof(LOC117));
		LOC117[0] = nosextractFilename(command);
		a = tocstringarray_153424(LOC117, 1, args, argslen0);
		res = posix_spawn(&pid, command->data, &fops, &attr, a, e);
	}
	goto LA113;
	LA115: ;
	{
		NimStringDesc* x;
		TY129263 LOC119;
		x = addcmdargs_153404(command, args, argslen0);
		memset((void*)LOC119, 0, sizeof(LOC119));
		LOC119[0] = copyString(x);
		a = tocstringarray_153424(TMP2539, 2, LOC119, 1);
		res = posix_spawn(&pid, "/bin/sh", &fops, &attr, a, e);
	}
	LA113: ;
	dealloccstringarray_9437(a);
	dealloccstringarray_9437(e);
	LOC120 = posix_spawn_file_actions_destroy(&fops);
	LOC121 = posix_spawnattr_destroy(&attr);
	{
		NI32 LOC126;
		if (!!((res == ((NI32) 0)))) goto LA124;
		LOC126 = oslasterror_92052();
		oserror_92005(LOC126);
	}
	LA124: ;
	{
		NimStringDesc* LOC131;
		if (!((options &(1<<((((NU8) 0))&7)))!=0)) goto LA129;
		LOC131 = 0;
		LOC131 = nsuJoinSep(args, argslen0, ((NimStringDesc*) &TMP2538));
		printf("%s%s%s\012", (command)->data, (((NimStringDesc*) &TMP2538))->data, (LOC131)->data);
	}
	LA129: ;
	(*result).Id = pid;
	{
		if (!((options &(1<<((((NU8) 3))&7)))!=0)) goto LA134;
		(*result).Inputhandle = ((int) 0);
		(*result).Outputhandle = ((int) 1);
		{
			if (!((options &(1<<((((NU8) 2))&7)))!=0)) goto LA138;
			(*result).Errorhandle = (*result).Outputhandle;
		}
		goto LA136;
		LA138: ;
		{
			(*result).Errorhandle = ((int) 2);
		}
		LA136: ;
	}
	goto LA132;
	LA134: ;
	{
		int LOC148;
		int LOC149;
		int LOC150;
		(*result).Inputhandle = pstdin[(1)- 0];
		(*result).Outputhandle = pstdout[(0)- 0];
		{
			int LOC146;
			if (!((options &(1<<((((NU8) 2))&7)))!=0)) goto LA144;
			(*result).Errorhandle = (*result).Outputhandle;
			LOC146 = close(pstderr[(0)- 0]);
		}
		goto LA142;
		LA144: ;
		{
			(*result).Errorhandle = pstderr[(0)- 0];
		}
		LA142: ;
		LOC148 = close(pstderr[(1)- 0]);
		LOC149 = close(pstdin[(0)- 0]);
		LOC150 = close(pstdout[(1)- 0]);
	}
	LA132: ;
	return result;
}

N_NIMCALL(tprocess152203*, startcmd_152246)(NimStringDesc* command, NU8 options) {
	tprocess152203* result;
	TY95234* c;
	TY95234* a;
	NI i_152291;
	NI HEX3Atmp_152293;
	NI res_152295;
	result = 0;
	c = nosparseCmdLine(command);
	a = 0;
	a = (TY95234*) newSeq((&NTI95234), (NI64)(c->Sup.len - 1));
	i_152291 = 0;
	HEX3Atmp_152293 = 0;
	HEX3Atmp_152293 = (NI64)(c->Sup.len - 1);
	res_152295 = 1;
	while (1) {
		NimStringDesc* LOC2;
		if (!(res_152295 <= HEX3Atmp_152293)) goto LA1;
		i_152291 = res_152295;
		LOC2 = 0;
		LOC2 = a->data[(NI64)(i_152291 - 1)]; a->data[(NI64)(i_152291 - 1)] = copyStringRC1(c->data[i_152291]);
		if (LOC2) nimGCunrefNoCycle(LOC2);
		res_152295 += 1;
	} LA1: ;
	result = nospstartProcess(c->data[0], ((NimStringDesc*) &TMP2542), a->data, a->Sup.len, NIM_NIL, options);
	return result;
}

N_NIMCALL(void, createstream_154009)(tstream150630** stream, int* handle, NU8 filemode) {
	FILE* f;
	tfilestream151125* LOC7;
	f = 0;
	{
		NIM_BOOL LOC3;
		NI32 LOC6;
		LOC3 = open_8826(&f, (*handle), filemode);
		if (!!(LOC3)) goto LA4;
		LOC6 = oslasterror_92052();
		oserror_92005(LOC6);
	}
	LA4: ;
	LOC7 = 0;
	LOC7 = newfilestream_151183(f);
	unsureAsgnRef((void**) &(*stream), &LOC7->Sup);
}

N_NIMCALL(tstream150630*, nospinputStream)(tprocess152203* p) {
	tstream150630* result;
	result = 0;
	{
		if (!((*p).Instream == NIM_NIL)) goto LA3;
		createstream_154009(&(*p).Instream, &(*p).Inputhandle, ((NU8) 1));
	}
	LA3: ;
	result = (*p).Instream;
	goto BeforeRet;
	BeforeRet: ;
	return result;
}

N_NIMCALL(tstream150630*, nospoutputStream)(tprocess152203* p) {
	tstream150630* result;
	result = 0;
	{
		if (!((*p).Outstream == NIM_NIL)) goto LA3;
		createstream_154009(&(*p).Outstream, &(*p).Outputhandle, ((NU8) 0));
	}
	LA3: ;
	result = (*p).Outstream;
	goto BeforeRet;
	BeforeRet: ;
	return result;
}

N_NIMCALL(NI, nospwaitForExit)(tprocess152203* p, NI timeout) {
	NI result;
	result = 0;
	{
		if (!!(((*p).Exitcode == ((NI32) -3)))) goto LA3;
		result = ((NI) ((*p).Exitcode));
		goto BeforeRet;
	}
	LA3: ;
	{
		pid_t LOC7;
		NI32 LOC10;
		LOC7 = waitpid((*p).Id, &(*p).Exitcode, ((int) 0));
		if (!(LOC7 < 0)) goto LA8;
		(*p).Exitcode = ((int) -3);
		LOC10 = oslasterror_92052();
		oserror_92005(LOC10);
	}
	LA8: ;
	result = (NI)((NU64)(((NI) ((*p).Exitcode))) >> (NU64)(8));
	BeforeRet: ;
	return result;
}

N_NIMCALL(NI, nospcountProcessors)(void) {
	NI result;
	result = 0;
	result = sysconf(_SC_NPROCESSORS_ONLN);
	{
		if (!(result <= 0)) goto LA3;
		result = 1;
	}
	LA3: ;
	return result;
}

N_NIMCALL(NI, nospexecCmd)(NimStringDesc* command) {
	NI result;
	int LOC1;
	result = 0;
	LOC1 = system(command->data);
	result = ((NI) (LOC1));
	return result;
}
N_NIMCALL(void, TMP3603)(void* p, NI op) {
	TY153003* a;
	NI LOC1;
	a = (TY153003*)p;
	for (LOC1 = 0; LOC1 < a->Sup.len; LOC1++) {
	nimGCvisit((void*)a->data[LOC1], op);
	}
}

static N_INLINE(void, asgnRefNoCycle)(void** dest, void* src) {
	{
		tcell38449* c;
		if (!!((src == NIM_NIL))) goto LA3;
		c = usrtocell_41843(src);
		(*c).Refcount += 8;
	}
	LA3: ;
	{
		tcell38449* c;
		if (!!(((*dest) == NIM_NIL))) goto LA7;
		c = usrtocell_41843((*dest));
		{
			(*c).Refcount -= 8;
			if (!((NU64)((*c).Refcount) < (NU64)(8))) goto LA11;
			rtladdzct_43002(c);
		}
		LA11: ;
	}
	LA7: ;
	(*dest) = src;
}

N_NIMCALL(NIM_BOOL, nosprunning)(tprocess152203* p) {
	NIM_BOOL result;
	pid_t ret;
	result = 0;
	ret = waitpid((*p).Id, &(*p).Exitcode, WNOHANG);
	{
		if (!(ret == 0)) goto LA3;
		result = NIM_TRUE;
		goto BeforeRet;
	}
	LA3: ;
	result = (ret == (*p).Id);
	BeforeRet: ;
	return result;
}

N_NIMCALL(void, nospclose)(tprocess152203* p) {
	int LOC13;
	int LOC14;
	int LOC15;
	{
		if (!!(((*p).Instream == NIM_NIL))) goto LA3;
		close_150675((*p).Instream);
	}
	LA3: ;
	{
		if (!!(((*p).Outstream == NIM_NIL))) goto LA7;
		close_150675((*p).Outstream);
	}
	LA7: ;
	{
		if (!!(((*p).Errstream == NIM_NIL))) goto LA11;
		close_150675((*p).Errstream);
	}
	LA11: ;
	LOC13 = close((*p).Inputhandle);
	LOC14 = close((*p).Outputhandle);
	LOC15 = close((*p).Errorhandle);
}

N_NIMCALL(NI, nospexecProcesses)(NimStringDesc** cmds, NI cmdslen0, NU8 options_152608, NI n) {
	NI result;
	NU8 options;
	result = 0;
	options = (options_152608 & ~ 8);
	{
		TY153003* q;
		NI m;
		NI i_153034;
		NI HEX3Atmp_153278;
		NI res_153280;
		NI i;
		NI j_153248;
		NI HEX3Atmp_153286;
		NI res_153288;
		if (!(1 < n)) goto LA3;
		q = 0;
		q = (TY153003*) newSeq((&NTI153003), n);
		m = ((n <= cmdslen0) ? n : cmdslen0);
		i_153034 = 0;
		HEX3Atmp_153278 = 0;
		HEX3Atmp_153278 = (NI64)(m - 1);
		res_153280 = 0;
		while (1) {
			if (!(res_153280 <= HEX3Atmp_153278)) goto LA5;
			i_153034 = res_153280;
			asgnRefNoCycle((void**) &q->data[i_153034], startcmd_152246(cmds[i_153034], options));
			res_153280 += 1;
		} LA5: ;
		i = m;
		while (1) {
			NI r_153211;
			NI HEX3Atmp_153282;
			NI res_153284;
			if (!(i <= (cmdslen0-1))) goto LA6;
			nossleep(50);
			r_153211 = 0;
			HEX3Atmp_153282 = 0;
			HEX3Atmp_153282 = (NI64)(n - 1);
			res_153284 = 0;
			while (1) {
				if (!(res_153284 <= HEX3Atmp_153282)) goto LA7;
				r_153211 = res_153284;
				{
					NIM_BOOL LOC10;
					NI LOC13;
					LOC10 = nosprunning(q->data[r_153211]);
					if (!!(LOC10)) goto LA11;
					LOC13 = nospwaitForExit(q->data[r_153211], -1);
					result = ((LOC13 >= result) ? LOC13 : result);
					{
						if (!!((q->data[r_153211] == NIM_NIL))) goto LA16;
						nospclose(q->data[r_153211]);
					}
					LA16: ;
					asgnRefNoCycle((void**) &q->data[r_153211], startcmd_152246(cmds[i], options));
					i += 1;
					{
						if (!((cmdslen0-1) < i)) goto LA20;
						goto LA7;
					}
					LA20: ;
				}
				LA11: ;
				res_153284 += 1;
			} LA7: ;
		} LA6: ;
		j_153248 = 0;
		HEX3Atmp_153286 = 0;
		HEX3Atmp_153286 = (NI64)(m - 1);
		res_153288 = 0;
		while (1) {
			NI LOC27;
			if (!(res_153288 <= HEX3Atmp_153286)) goto LA22;
			j_153248 = res_153288;
			{
				if (!!((q->data[j_153248] == NIM_NIL))) goto LA25;
				nospclose(q->data[j_153248]);
			}
			LA25: ;
			LOC27 = nospwaitForExit(q->data[j_153248], -1);
			result = ((LOC27 >= result) ? LOC27 : result);
			res_153288 += 1;
		} LA22: ;
	}
	goto LA1;
	LA3: ;
	{
		NI i_153271;
		NI HEX3Atmp_153290;
		NI res_153292;
		i_153271 = 0;
		HEX3Atmp_153290 = 0;
		HEX3Atmp_153290 = (cmdslen0-1);
		res_153292 = 0;
		while (1) {
			tprocess152203* p;
			NI LOC30;
			if (!(res_153292 <= HEX3Atmp_153290)) goto LA29;
			i_153271 = res_153292;
			p = startcmd_152246(cmds[i_153271], options);
			LOC30 = nospwaitForExit(p, -1);
			result = ((LOC30 >= result) ? LOC30 : result);
			nospclose(p);
			res_153292 += 1;
		} LA29: ;
	}
	LA1: ;
	return result;
}
N_NOINLINE(void, osprocInit)(void) {
}

N_NOINLINE(void, osprocDatInit)(void) {
static TNimNode* TMP2533[8];
static TNimNode TMP486[9];
NTI152203.size = sizeof(tprocess152203);
NTI152203.kind = 17;
NTI152203.base = (&NTI1009);
NTI152203.flags = 2;
TMP2533[0] = &TMP486[1];
TMP486[1].kind = 1;
TMP486[1].offset = offsetof(tprocess152203, Inputhandle);
TMP486[1].typ = (&NTI8808);
TMP486[1].name = "inputHandle";
TMP2533[1] = &TMP486[2];
TMP486[2].kind = 1;
TMP486[2].offset = offsetof(tprocess152203, Outputhandle);
TMP486[2].typ = (&NTI8808);
TMP486[2].name = "outputHandle";
TMP2533[2] = &TMP486[3];
TMP486[3].kind = 1;
TMP486[3].offset = offsetof(tprocess152203, Errorhandle);
TMP486[3].typ = (&NTI8808);
TMP486[3].name = "errorHandle";
TMP2533[3] = &TMP486[4];
TMP486[4].kind = 1;
TMP486[4].offset = offsetof(tprocess152203, Instream);
TMP486[4].typ = (&NTI150628);
TMP486[4].name = "inStream";
TMP2533[4] = &TMP486[5];
TMP486[5].kind = 1;
TMP486[5].offset = offsetof(tprocess152203, Outstream);
TMP486[5].typ = (&NTI150628);
TMP486[5].name = "outStream";
TMP2533[5] = &TMP486[6];
TMP486[6].kind = 1;
TMP486[6].offset = offsetof(tprocess152203, Errstream);
TMP486[6].typ = (&NTI150628);
TMP486[6].name = "errStream";
TMP2533[6] = &TMP486[7];
TMP486[7].kind = 1;
TMP486[7].offset = offsetof(tprocess152203, Id);
TMP486[7].typ = (&NTI84455);
TMP486[7].name = "id";
TMP2533[7] = &TMP486[8];
TMP486[8].kind = 1;
TMP486[8].offset = offsetof(tprocess152203, Exitcode);
TMP486[8].typ = (&NTI3701);
TMP486[8].name = "exitCode";
TMP486[0].len = 8; TMP486[0].kind = 2; TMP486[0].sons = &TMP2533[0];
NTI152203.node = &TMP486[0];
NTI152205.size = sizeof(tprocess152203*);
NTI152205.kind = 22;
NTI152205.base = (&NTI152203);
NTI152205.flags = 2;
NTI152205.marker = TMP2536;
NTI153003.size = sizeof(TY153003*);
NTI153003.kind = 24;
NTI153003.base = (&NTI152205);
NTI153003.flags = 2;
NTI153003.marker = TMP3603;
}

