/* Generated by Nimrod Compiler v0.9.3 */
/*   (c) 2012 Andreas Rumpf */
/* The generated code is subject to the original license. */
/* Compiled for: MacOSX, amd64, gcc */
/* Command for C compiler:
   gcc -c  -w -O3 -fno-strict-aliasing  -I/usr/src/extras/Nimrod/lib -o compiler/nimcache/streams.o compiler/nimcache/streams.c */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <stdio.h>
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct tstream150630 tstream150630;
typedef struct TNimObject TNimObject;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
typedef struct tfilestream151125 tfilestream151125;
typedef struct eio1033 eio1033;
typedef struct esystem1031 esystem1031;
typedef struct esynch1029 esynch1029;
typedef struct E_Base E_Base;
typedef struct tcell38449 tcell38449;
typedef struct tcellseq38465 tcellseq38465;
typedef struct tgcheap40416 tgcheap40416;
typedef struct tcellset38461 tcellset38461;
typedef struct tpagedesc38457 tpagedesc38457;
typedef struct tmemregion22010 tmemregion22010;
typedef struct tsmallchunk21243 tsmallchunk21243;
typedef struct tllchunk22004 tllchunk22004;
typedef struct tbigchunk21245 tbigchunk21245;
typedef struct tintset21218 tintset21218;
typedef struct ttrunk21214 ttrunk21214;
typedef struct tavlnode22008 tavlnode22008;
typedef struct tgcstat40414 tgcstat40414;
typedef struct tbasechunk21241 tbasechunk21241;
typedef struct tfreecell21233 tfreecell21233;
typedef N_NIMCALL_PTR(void, TY891) (void* p, NI op);
struct TNimType {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY891 marker;
};
struct TNimNode {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct TNimObject {
TNimType* m_type;
};
typedef N_NIMCALL_PTR(void, TY150631) (tstream150630* s);
typedef N_NIMCALL_PTR(NIM_BOOL, TY150635) (tstream150630* s);
typedef N_NIMCALL_PTR(void, TY150639) (tstream150630* s, NI pos);
typedef N_NIMCALL_PTR(NI, TY150644) (tstream150630* s);
typedef N_NIMCALL_PTR(NI, TY150648) (tstream150630* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY150654) (tstream150630* s, void* buffer, NI buflen);
typedef N_NIMCALL_PTR(void, TY150660) (tstream150630* s);
struct tstream150630 {
  TNimObject Sup;
TY150631 Closeimpl;
TY150635 Atendimpl;
TY150639 Setpositionimpl;
TY150644 Getpositionimpl;
TY150648 Readdataimpl;
TY150654 Writedataimpl;
TY150660 Flushimpl;
};
struct TGenericSeq {
NI len;
NI reserved;
};
typedef NIM_CHAR TY611[100000001];
struct NimStringDesc {
  TGenericSeq Sup;
TY611 data;
};
struct tfilestream151125 {
  tstream150630 Sup;
FILE* F;
};
struct E_Base {
  TNimObject Sup;
E_Base* parent;
NCSTRING name;
NimStringDesc* message;
NimStringDesc* trace;
};
struct esynch1029 {
  E_Base Sup;
};
struct esystem1031 {
  esynch1029 Sup;
};
struct eio1033 {
  esystem1031 Sup;
};
struct tcell38449 {
NI Refcount;
TNimType* Typ;
};
struct tcellseq38465 {
NI Len;
NI Cap;
tcell38449** D;
};
struct tcellset38461 {
NI Counter;
NI Max;
tpagedesc38457* Head;
tpagedesc38457** Data;
};
typedef tsmallchunk21243* TY22022[512];
typedef ttrunk21214* ttrunkbuckets21216[256];
struct tintset21218 {
ttrunkbuckets21216 Data;
};
struct tmemregion22010 {
NI Minlargeobj;
NI Maxlargeobj;
TY22022 Freesmallchunks;
tllchunk22004* Llmem;
NI Currmem;
NI Maxmem;
NI Freemem;
NI Lastsize;
tbigchunk21245* Freechunkslist;
tintset21218 Chunkstarts;
tavlnode22008* Root;
tavlnode22008* Deleted;
tavlnode22008* Last;
tavlnode22008* Freeavlnodes;
};
struct tgcstat40414 {
NI Stackscans;
NI Cyclecollections;
NI Maxthreshold;
NI Maxstacksize;
NI Maxstackcells;
NI Cycletablesize;
NI64 Maxpause;
};
struct tgcheap40416 {
void* Stackbottom;
NI Cyclethreshold;
tcellseq38465 Zct;
tcellseq38465 Decstack;
tcellset38461 Cycleroots;
tcellseq38465 Tempstack;
NI Recgclock;
tmemregion22010 Region;
tgcstat40414 Stat;
};
typedef NI TY21221[8];
struct tpagedesc38457 {
tpagedesc38457* Next;
NI Key;
TY21221 Bits;
};
struct tbasechunk21241 {
NI Prevsize;
NI Size;
NIM_BOOL Used;
};
struct tsmallchunk21243 {
  tbasechunk21241 Sup;
tsmallchunk21243* Next;
tsmallchunk21243* Prev;
tfreecell21233* Freelist;
NI Free;
NI Acc;
NF64 Data;
};
struct tllchunk22004 {
NI Size;
NI Acc;
tllchunk22004* Next;
};
struct tbigchunk21245 {
  tbasechunk21241 Sup;
tbigchunk21245* Next;
tbigchunk21245* Prev;
NI Align;
NF64 Data;
};
struct ttrunk21214 {
ttrunk21214* Next;
NI Key;
TY21221 Bits;
};
typedef tavlnode22008* TY22014[2];
struct tavlnode22008 {
TY22014 Link;
NI Key;
NI Upperbound;
NI Level;
};
struct tfreecell21233 {
tfreecell21233* Next;
NI Zerofield;
};
N_NIMCALL(void, TMP2535)(void* p, NI op);
N_NIMCALL(void, writedata_150747)(tstream150630* s, void* buffer, NI buflen);
N_NIMCALL(void, TMP2543)(void* p, NI op);
N_NIMCALL(void*, newObj)(TNimType* typ, NI size);
N_NIMCALL(void, fsclose_151128)(tstream150630* s);
N_NIMCALL(NIM_BOOL, fsatend_151149)(tstream150630* s);
N_NIMCALL(NIM_BOOL, endoffile_9027)(FILE* f);
N_NIMCALL(void, fssetposition_151155)(tstream150630* s, NI pos);
N_NIMCALL(void, setfilepos_9141)(FILE* f, NI64 pos);
N_NIMCALL(NI, fsgetposition_151161)(tstream150630* s);
N_NIMCALL(NI64, getfilepos_9145)(FILE* f);
N_NIMCALL(NI, fsreaddata_151168)(tstream150630* s, void* buffer, NI buflen);
N_NIMCALL(NI, readbuffer_9117)(FILE* f, void* buffer, NI len);
N_NIMCALL(void, fswritedata_151176)(tstream150630* s, void* buffer, NI buflen);
N_NIMCALL(NI, writebuffer_9136)(FILE* f, void* buffer, NI len);
N_NIMCALL(eio1033*, neweio_150605)(NimStringDesc* msg);
N_NIMCALL(NimStringDesc*, copyStringRC1)(NimStringDesc* src);
static N_INLINE(void, nimGCunrefNoCycle)(void* p);
static N_INLINE(tcell38449*, usrtocell_41843)(void* usr);
static N_INLINE(void, rtladdzct_43002)(tcell38449* c);
N_NOINLINE(void, addzct_41815)(tcellseq38465* s, tcell38449* c);
N_NIMCALL(void, raiseException)(E_Base* e, NCSTRING ename);
N_NIMCALL(void, fsflush_151144)(tstream150630* s);
N_NIMCALL(NimStringDesc*, copyString)(NimStringDesc* src);
N_NIMCALL(NIM_CHAR, readchar_150807)(tstream150630* s);
N_NIMCALL(NI, readdata_150730)(tstream150630* s, void* buffer, NI buflen);
N_NIMCALL(NimStringDesc*, addChar)(NimStringDesc* s, NIM_CHAR c);
STRING_LITERAL(TMP2546, "cannot write to stream", 22);
STRING_LITERAL(TMP2547, "", 0);
extern TNimType NTI1009; /* TObject */
TNimType NTI150630; /* TStream */
TNimType NTI150631; /* proc (PStream) */
TNimType NTI150635; /* proc (PStream): bool */
TNimType NTI150639; /* proc (PStream, int) */
TNimType NTI150644; /* proc (PStream): int */
TNimType NTI150648; /* proc (PStream, pointer, int): int */
TNimType NTI150654; /* proc (PStream, pointer, int) */
TNimType NTI150660; /* proc (PStream) */
TNimType NTI150628; /* PStream */
TNimType NTI151125; /* TFileStream */
extern TNimType NTI8804; /* TFile */
TNimType NTI151123; /* PFileStream */
extern TNimType NTI9001; /* ref EIO */
extern TNimType NTI1033; /* EIO */
extern tgcheap40416 gch_40442;
N_NIMCALL(void, TMP2535)(void* p, NI op) {
	tstream150630* a;
	a = (tstream150630*)p;
}

N_NIMCALL(void, writedata_150747)(tstream150630* s, void* buffer, NI buflen) {
	(*s).Writedataimpl(s, buffer, buflen);
}

N_NIMCALL(void, write_150771)(tstream150630* s, NimStringDesc* x) {
	writedata_150747(s, ((void*) (x->data)), x->Sup.len);
}
N_NIMCALL(void, TMP2543)(void* p, NI op) {
	tfilestream151125* a;
	a = (tfilestream151125*)p;
}

N_NIMCALL(void, fsclose_151128)(tstream150630* s) {
	{
		if (!!(((*((tfilestream151125*) (s))).F == NIM_NIL))) goto LA3;
		fclose((*((tfilestream151125*) (s))).F);
		(*((tfilestream151125*) (s))).F = NIM_NIL;
	}
	LA3: ;
}

N_NIMCALL(NIM_BOOL, fsatend_151149)(tstream150630* s) {
	NIM_BOOL result;
	result = 0;
	result = endoffile_9027((*((tfilestream151125*) (s))).F);
	goto BeforeRet;
	BeforeRet: ;
	return result;
}

N_NIMCALL(void, fssetposition_151155)(tstream150630* s, NI pos) {
	setfilepos_9141((*((tfilestream151125*) (s))).F, ((NI64) (pos)));
}

N_NIMCALL(NI, fsgetposition_151161)(tstream150630* s) {
	NI result;
	NI64 LOC1;
	result = 0;
	LOC1 = getfilepos_9145((*((tfilestream151125*) (s))).F);
	result = ((NI) (LOC1));
	goto BeforeRet;
	BeforeRet: ;
	return result;
}

N_NIMCALL(NI, fsreaddata_151168)(tstream150630* s, void* buffer, NI buflen) {
	NI result;
	result = 0;
	result = readbuffer_9117((*((tfilestream151125*) (s))).F, buffer, buflen);
	return result;
}

static N_INLINE(tcell38449*, usrtocell_41843)(void* usr) {
	tcell38449* result;
	result = 0;
	result = ((tcell38449*) ((NI)((NU64)(((NI) (usr))) - (NU64)(((NI)sizeof(tcell38449))))));
	return result;
}

static N_INLINE(void, rtladdzct_43002)(tcell38449* c) {
	addzct_41815(&gch_40442.Zct, c);
}

static N_INLINE(void, nimGCunrefNoCycle)(void* p) {
	tcell38449* c;
	c = usrtocell_41843(p);
	{
		(*c).Refcount -= 8;
		if (!((NU64)((*c).Refcount) < (NU64)(8))) goto LA3;
		rtladdzct_43002(c);
	}
	LA3: ;
}

N_NIMCALL(eio1033*, neweio_150605)(NimStringDesc* msg) {
	eio1033* result;
	NimStringDesc* LOC1;
	result = 0;
	result = (eio1033*) newObj((&NTI9001), sizeof(eio1033));
	(*result).Sup.Sup.Sup.Sup.m_type = (&NTI1033);
	LOC1 = 0;
	LOC1 = (*result).Sup.Sup.Sup.message; (*result).Sup.Sup.Sup.message = copyStringRC1(msg);
	if (LOC1) nimGCunrefNoCycle(LOC1);
	return result;
}

N_NIMCALL(void, fswritedata_151176)(tstream150630* s, void* buffer, NI buflen) {
	{
		NI LOC3;
		eio1033* LOC6;
		LOC3 = writebuffer_9136((*((tfilestream151125*) (s))).F, buffer, buflen);
		if (!!((LOC3 == buflen))) goto LA4;
		LOC6 = 0;
		LOC6 = neweio_150605(((NimStringDesc*) &TMP2546));
		raiseException((E_Base*)LOC6, "EIO");
	}
	LA4: ;
}

N_NIMCALL(void, fsflush_151144)(tstream150630* s) {
	fflush((*((tfilestream151125*) (s))).F);
}

N_NIMCALL(tfilestream151125*, newfilestream_151183)(FILE* f) {
	tfilestream151125* result;
	result = 0;
	result = (tfilestream151125*) newObj((&NTI151123), sizeof(tfilestream151125));
	(*result).Sup.Sup.m_type = (&NTI151125);
	(*result).F = f;
	(*result).Sup.Closeimpl = fsclose_151128;
	(*result).Sup.Atendimpl = fsatend_151149;
	(*result).Sup.Setpositionimpl = fssetposition_151155;
	(*result).Sup.Getpositionimpl = fsgetposition_151161;
	(*result).Sup.Readdataimpl = fsreaddata_151168;
	(*result).Sup.Writedataimpl = fswritedata_151176;
	(*result).Sup.Flushimpl = fsflush_151144;
	return result;
}

N_NIMCALL(void, close_150675)(tstream150630* s) {
	{
		if (!!((*s).Closeimpl == 0)) goto LA3;
		(*s).Closeimpl(s);
	}
	LA3: ;
}

N_NIMCALL(NIM_BOOL, atend_150691)(tstream150630* s) {
	NIM_BOOL result;
	result = 0;
	result = (*s).Atendimpl(s);
	return result;
}

N_NIMCALL(NI, readdata_150730)(tstream150630* s, void* buffer, NI buflen) {
	NI result;
	result = 0;
	result = (*s).Readdataimpl(s, buffer, buflen);
	return result;
}

N_NIMCALL(NIM_CHAR, readchar_150807)(tstream150630* s) {
	NIM_CHAR result;
	result = 0;
	{
		NI LOC3;
		LOC3 = readdata_150730(s, ((void*) (&result)), 1);
		if (!!((LOC3 == 1))) goto LA4;
		result = 0;
	}
	LA4: ;
	return result;
}

N_NIMCALL(NimStringDesc*, readline_150993)(tstream150630* s) {
	NimStringDesc* result;
	result = 0;
	result = copyString(((NimStringDesc*) &TMP2547));
	while (1) {
		NIM_CHAR c;
		c = readchar_150807(s);
		{
			if (!((NU8)(c) == (NU8)(13))) goto LA4;
			c = readchar_150807(s);
			goto LA1;
		}
		LA4: ;
		{
			NIM_BOOL LOC8;
			LOC8 = ((NU8)(c) == (NU8)(10));
			if (LOC8) goto LA9;
			LOC8 = ((NU8)(c) == (NU8)(0));
			LA9: ;
			if (!LOC8) goto LA10;
			goto LA1;
		}
		goto LA6;
		LA10: ;
		{
			result = addChar(result, c);
		}
		LA6: ;
	} LA1: ;
	return result;
}
N_NOINLINE(void, streamsInit)(void) {
}

N_NOINLINE(void, streamsDatInit)(void) {
static TNimNode* TMP2534[7];
static TNimNode TMP488[9];
NTI150630.size = sizeof(tstream150630);
NTI150630.kind = 17;
NTI150630.base = (&NTI1009);
NTI150630.flags = 3;
TMP2534[0] = &TMP488[1];
NTI150631.size = sizeof(TY150631);
NTI150631.kind = 25;
NTI150631.base = 0;
NTI150631.flags = 3;
TMP488[1].kind = 1;
TMP488[1].offset = offsetof(tstream150630, Closeimpl);
TMP488[1].typ = (&NTI150631);
TMP488[1].name = "closeImpl";
TMP2534[1] = &TMP488[2];
NTI150635.size = sizeof(TY150635);
NTI150635.kind = 25;
NTI150635.base = 0;
NTI150635.flags = 3;
TMP488[2].kind = 1;
TMP488[2].offset = offsetof(tstream150630, Atendimpl);
TMP488[2].typ = (&NTI150635);
TMP488[2].name = "atEndImpl";
TMP2534[2] = &TMP488[3];
NTI150639.size = sizeof(TY150639);
NTI150639.kind = 25;
NTI150639.base = 0;
NTI150639.flags = 3;
TMP488[3].kind = 1;
TMP488[3].offset = offsetof(tstream150630, Setpositionimpl);
TMP488[3].typ = (&NTI150639);
TMP488[3].name = "setPositionImpl";
TMP2534[3] = &TMP488[4];
NTI150644.size = sizeof(TY150644);
NTI150644.kind = 25;
NTI150644.base = 0;
NTI150644.flags = 3;
TMP488[4].kind = 1;
TMP488[4].offset = offsetof(tstream150630, Getpositionimpl);
TMP488[4].typ = (&NTI150644);
TMP488[4].name = "getPositionImpl";
TMP2534[4] = &TMP488[5];
NTI150648.size = sizeof(TY150648);
NTI150648.kind = 25;
NTI150648.base = 0;
NTI150648.flags = 3;
TMP488[5].kind = 1;
TMP488[5].offset = offsetof(tstream150630, Readdataimpl);
TMP488[5].typ = (&NTI150648);
TMP488[5].name = "readDataImpl";
TMP2534[5] = &TMP488[6];
NTI150654.size = sizeof(TY150654);
NTI150654.kind = 25;
NTI150654.base = 0;
NTI150654.flags = 3;
TMP488[6].kind = 1;
TMP488[6].offset = offsetof(tstream150630, Writedataimpl);
TMP488[6].typ = (&NTI150654);
TMP488[6].name = "writeDataImpl";
TMP2534[6] = &TMP488[7];
NTI150660.size = sizeof(TY150660);
NTI150660.kind = 25;
NTI150660.base = 0;
NTI150660.flags = 3;
TMP488[7].kind = 1;
TMP488[7].offset = offsetof(tstream150630, Flushimpl);
TMP488[7].typ = (&NTI150660);
TMP488[7].name = "flushImpl";
TMP488[0].len = 7; TMP488[0].kind = 2; TMP488[0].sons = &TMP2534[0];
NTI150630.node = &TMP488[0];
NTI150628.size = sizeof(tstream150630*);
NTI150628.kind = 22;
NTI150628.base = (&NTI150630);
NTI150628.flags = 2;
NTI150628.marker = TMP2535;
NTI151125.size = sizeof(tfilestream151125);
NTI151125.kind = 17;
NTI151125.base = (&NTI150630);
NTI151125.flags = 3;
TMP488[8].kind = 1;
TMP488[8].offset = offsetof(tfilestream151125, F);
TMP488[8].typ = (&NTI8804);
TMP488[8].name = "f";
NTI151125.node = &TMP488[8];
NTI151123.size = sizeof(tfilestream151125*);
NTI151123.kind = 22;
NTI151123.base = (&NTI151125);
NTI151123.flags = 2;
NTI151123.marker = TMP2543;
}

